---
title: "A journey to gghdr"
output: 
  rmarkdown::html_vignette:
vignette: >
  %\VignetteIndexEntry{Exploring probability distributions for cricket}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tufte)
library(ggpubr)
library(gghdr)
```

> They may forget what you said, but they will never forget how you made them feel.
> 
> `r tufte::quote_footer('Carl W. Buehner')`

This was how being a newcomer to [rOpenSci OzUnconf 2019](https://ozunconf19.ropensci.org/) felt. It is incredible to be a part of such a diverse, welcoming and inclusive environment. I thought it would be fun to blog about how we all came together to create this project and the twists and turns along the way.  

You can learn about our package `gghdr` at [the package website](https://ropenscilabs.github.io/gghdr/), and the [Github repo](https://ropenscilabs.github.io/gghdr/).

## Why is HDR useful?

Let us look at a familiar data set `ggplot2::mpg`, containing the technical specifications of a sample of cars with variables `hwy` specifying highway miles per gallon and `cyl` specifying number of cylinders. The histogram (a) shows that cars with 6 cylinders are bimodally distributed, which is reflected in the highest density region (HDR) plots (b) but not in the standard boxplot (c). Hence, we see that HDRs are useful in displaying multimodality in the distribution. 

```{r mpgBox1, fig.width = 5, fig.height = 4,echo=FALSE}
p1 <- ggplot(data = mpg, 
       aes(x = hwy, fill = as.factor(cyl))) +
  facet_grid(as.factor(cyl)~.) + 
  geom_histogram(bins = 50) + theme(legend.position = "bottom") + ggtitle("a")

p2 <- ggplot(data = mpg, 
       # make sure to change x to y from geom_density to geom_hdr_boxplot
       aes(y = hwy, fill = as.factor(cyl))) + 
  geom_boxplot() + ggtitle("b")

p3 <- ggplot(data = mpg, 
       # make sure to change x to y from geom_density to geom_hdr_boxplot
       aes(y = hwy, fill = as.factor(cyl))) + 
  geom_hdr_boxplot()+ ggtitle("c")

p1
p2
p3
```

# Initiation

Initially, the aim was to visualize _Highest Density Regions_ (HDR) in one and two dimensions under the [ggplot2](https://ggplot2.tidyverse.org/) framework. This work is inspired by the package [hdrcde](https://cran.r-project.org/web/packages/hdrcde/index.html) developed by [Rob J Hyndman](https://robjhyndman.com/). Since the [paper](https://www.jstor.org/stable/2684423?seq=1) was written almost 20 years ago and the package came 12 years ago, the need to reexamine it through the ggplot2 lenses had been lurking around for a while. While I read the paper and attempted using `hdrcde` a year back, it did feel less powerful not being able to use `ggplot2` and the flexibilities that come along with it, not forgetting that there was a point when [Mitch](https://blog.mitchelloharawild.com/) had been threatening me that he would get this done overnight if I don’t. (I bet he would have had he not been raising chickens and bees). So one fine day, he suggested that the [rOpensci](https://ropensci.org/) [ozunconference](https://ozunconf19.ropensci.org/) could be the right place to do this together, and I thought this was a brilliant idea as I had read about [Nick's](https://www.njtierney.com/) [experience](https://ropensci.org/blog/2017/10/31/ozunconf2017/) earlier and was thrilled to be a part of it. 

This event is quite different in the sense that it is mostly invite-only, where past attendees can recommend new ones. Mitch was a participant at [rOpenSci OzUnconf 2018](https://ozunconf18.ropensci.org/#about). So he could invite me to work on this project with him at rOpenSci ozunconf 2019. Soon I had applied and we were accepted. Thanks to the organizers of the [rOpenSci ozunconference](https://ozunconf19.ropensci.org/) for the opportunity and excellent management of what has turned out to be a highly stimulating experience. 

# Planning and execution

Shortly after we were accepted, Mitch posted the idea on the [rOpenSci Github issues page](https://github.com/ropensci/ozunconf19/issues). Posting an issue like this is a great place to start a discussion on a rough idea or to learn more or comment on any idea that you find exciting. We brainstormed for a couple of days on how [`hdrcde`](https://github.com/robjhyndman/hdrcde) worked and what are the potential functions and features we would like to have or improve in the new package. The discussion led to a workflow which pretty much looked like this: 


```{r image-board, echo = F}
knitr::include_graphics(here::here("/man/figures/board.jpg"))
```

Doing a bit of brainstorming on the project ahead of time helped us to set the expectations, and communicate them to potential team members. Although it is worth mentioning that projects don't need to be fully fleshed out ahead of time - the ozunconf organisers strongly encourage working on projects that you thought of even on that very day.

Fast-forward to the first day of the conference! The participants had already suggested ideas (there were many brilliant ones - have a read [here](https://github.com/ropensci/ozunconf19/issues)) and then voting started for the projects people were excited to be associated with. Little did we know that time there would be five more enthusiasts ([Stephen Pearce](https://github.com/sparce), [Ryo Nakagawara](https://github.com/Ryo-N7), [Darya Vanichkina](https://github.com/dvanic), [Emi Tanaka](https://emitanaka.org/) and [Thomas Fung](https://github.com/thomas-fung)) who would be as eager to contribute to this project and learn about ggplot2 internals (very aptly put by Mitch while advertising the project. Smart move mate)! Oh, and what a fun and collaborative team to work with! See how they won’t stop coding:

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Channeling our inner <a href="https://twitter.com/hadleywickham?ref_src=twsrc%5Etfw">@hadleywickham</a> at <a href="https://twitter.com/rOpenSci?ref_src=twsrc%5Etfw">@rOpenSci</a> <a href="https://twitter.com/hashtag/ozunconf19?src=hash&amp;ref_src=twsrc%5Etfw">#ozunconf19</a>.<br>Are we doing it right? <a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a> <a href="https://t.co/F7EbFEjbVl">pic.twitter.com/F7EbFEjbVl</a></p>&mdash; Mitchell O&#39;Hara-Wild (@mitchoharawild) <a href="https://twitter.com/mitchoharawild/status/1205008586130149376?ref_src=twsrc%5Etfw">December 12, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<!-- [https://twitter.com/mitchoharawild/status/1205008586130149376] (Thanks to Steph who spent a lot of effort in making this gif) -->

At the end of the two days, we had established the following:

1. `geom_hdr_boxplot()` to replace `hdr.boxplot()` to calculate HDR boxplots in one dimension.

<div class = "row">
<div class = "col-md-6">
__Before:__
```{r hdrcde-boxplot, echo=TRUE, message=FALSE, warning=FALSE}
library(hdrcde)
hdr.boxplot(faithful$eruptions) 
```
</div>
<div class = "col-md-6">
__After:__
```{r gghdr-boxplot, echo=TRUE, message=FALSE, warning=FALSE}
library(gghdr)
library(ggplot2)
ggplot(faithful, aes(y = eruptions)) +
  geom_hdr_boxplot() 
```
</div>
</div>

2. The interval bars in `hdr.den()` to be replaced with a rug plot to display HDRs of 1d marginal distributions in `geom_hdr_rug()`. `geom_density()` could then be added to the resultant plot to get plots equivalent to `hdr.den()`.
 
<div class = "row">
<div class = "col-md-6">
__Before:__
```{r hdrcde-den, echo=TRUE, message=FALSE, warning=FALSE}
library(hdrcde)
hdr.den(faithful$eruptions,
        col = c("skyblue", "slateblue2", "slateblue4"))
```
</div>
<div class = "col-md-6">
__After:__
```{r gghdr-den, echo=TRUE, message=FALSE, warning=FALSE}
library(gghdr)
library(ggplot2)
library(dplyr)
faithful %>% ggplot(aes(x = eruptions)) +
  geom_density(n= 1001, bw = hdrcde::hdrbw(faithful$eruptions, mean(c(0.5, 0.95, 0.99)))) +
  geom_hdr_rug(fill=  "blue") + 
  xlim(c(0.6833018, 6.0166982))
```
</div>
</div>

Also, the display of 1d marginal distributions for both variables could be a useful feature to have.

```{r}
ggplot(faithful, aes(y = eruptions, x = waiting)) + 
  geom_hdr_rug(sides = "trbl", fill = "blue") + 
  geom_point()
```

3. `hdr_bin()` to replace `hdrscatterplot()`. This would not be an independent geom, but rather a function to add in the aesthetic color with each color representing an HDR with a specified coverage.

<div class = "row">
<div class = "col-md-6">
__Before:__
```{r hdrcde-scatterplot, echo=TRUE, message=FALSE, warning=FALSE}
hdrscatterplot(faithful$waiting,
               faithful$eruptions)
```
</div>
<div class = "col-md-6">
__After:__
```{r gghdr-scatterplot, echo=TRUE, message=FALSE, warning=FALSE}
ggplot(data = faithful, 
       aes(x = waiting, y = eruptions)) +
  geom_point(aes(colour = hdr_bin(x = waiting,
                                  y = eruptions)))
```
</div>
</div>


4. `geom_hdrcde_boxplot()` to replace `hdr.cde()` which is used in HDRs for a conditional density estimate.

<div class = "row">
<div class = "col-md-6">
__Before:__
```{r hdrcde-cde, echo=TRUE, message=FALSE, warning=FALSE}
faithful.cde <- cde(faithful$waiting, faithful$eruptions)
plot(faithful.cde, plot.fn = "hdr",
     xlab = "Waiting time", ylab = "Duration time")
```
</div>
<div class = "col-md-6">
__After:__
```{r gghdr-cde, echo=TRUE, message=FALSE, warning=FALSE}
ggplot(faithful, aes(x = eruptions, y = waiting)) + 
    geom_hdr_boxplot(fill="steelblue") + 
    theme_minimal()
```
</div>
</div>

5. We also deliberated on names of potential functions at the brainstorming stage which led to the idea of a [package design collaboration corner](https://github.com/ropensci/ozunconf19/issues/19). 

6. Documentation, testing and illustrative followed along the way to make it CRAN ready.


# Bottlenecks along the way

- Now where there's a will, there's a way. Except that soon we could say where there is a merge, there is a conflict.  While most times we use [Github](https://github.com/) for code-sharing, publishing software and collaborating with our future self, this was the time to show how we collaborate with others. It took almost 2 hours, GitKraken and Mitch to get us out of the merge conflicts.

```{r conflict-tree,echo=FALSE}
knitr::include_graphics(here::here("/man/figures/conflict-tree.png"))
```


<!-- - Extending ggplot2 (https://cran.r-project.org/web/packages/ggplot2/vignettes/extending-ggplot2.html). __(Writing about the scale problem that was faced.)__ -->


# Where to from here?

A missing piece is to replace the `hdr.boxplot.2d()` with `geom_hdr_boxplot.2d()`, which would calculate and plot HDRs in two dimensions. Nevertheless, we have the raw materials for an R package. All we need is some embellishment and (lots of) review to get it on CRAN. Kudos team!!

```{r image-team, echo = F}
knitr::include_graphics(here::here("/man/figures/team.jpg"))
```

