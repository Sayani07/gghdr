---
title: "A journey to gghdr"
author: "Sayani Gupta"
date: "02/02/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

>They may forget what you said, but they will never forget how you made them feel.

This was how being a newcomer in [rOpenSci OzUnconf 2019](https://ozunconf19.ropensci.org/) felt like.  While you can read about the project on [the package website](https://github.com/ropenscilabs/gghdr) or learn more about it on [Github](https://ropenscilabs.github.io/gghdr/) - what would be more fun to talk about would be how we all came and worked together to make this project happen and the twists and turns along the way. 

<!-- It started with Steph reminding us of the code of conduct regarding providing a safe and inclusive environment for all. And then when Nicholas Tierney and Sarah takes the stage to cover a tutorial, then you can feel the code of conduct is no fake or just another statement in this community. -->


<!-- While it was not different that like any community event, it started with the code of conduct and commitment to provide a safe and inclusive environment to all, uniqueness was in implementing it right there. -->

# Initiation

To start off, the aim was to visualize Highest Density Regions (HDR) in one and two dimensions under the ggplot2 framework. HDRs are useful in displaying multimodality in the distribution. This work is inspired by the package [hdrcde](https://cran.r-project.org/web/packages/hdrcde/index.html) developed by [Rob J Hyndman](https://robjhyndman.com/). Since the [paper](https://www.jstor.org/stable/2684423?seq=1) was written almost 20 years ago and the package came 12 years ago, the need to use it under ggplot2 framework had been lurking around for some time now. While I read the paper and attempted using hdrcde an year back, it did feel less powerful not being able to use ggplot and the flexibilities that come along with it, not forgetting that there was a point when Mitch had been threatening me that he would get this done overnight if I don’t. (I bet he would have had he not fostered some chicken and bees). Although one fine day he suggested that rOpensci is the right place to do this together. This was a brilliant idea as I had read about the [Nicholas Tierney's](https://www.njtierney.com/) [experience](https://ropensci.org/blog/2017/10/31/ozunconf2017/) and wanted to be a part of it. Thanks to the organizers of RopenSci for the opportunity and excellent management of what has turned out to be a highly stimulating experience. 

# Planning and execution

Shortly after we got to know we are a part of RopenSci 2019, Mitch posted the idea on the [issues](https://github.com/ropensci/ozunconf19/issues). This is a great place to start discussion on a rough idea or to learn more or comment on any idea that you find exciting. We brainstormed for a couple of days on how [`hdrcde`](https://github.com/robjhyndman/hdrcde) worked and what are the potential functions and features we would like to have or improve in the new package. The discussion led to a workflow which pretty much looked like this: 

(show the board diagram).


First forward to the first day of the conference! The participants had already suggested ideas (there were many brilliant ones - find it [here](https://github.com/ropensci/ozunconf19/issues)) and then voting started for the projects people are excited to be associated with. Little did we know that time there will be five more enthusiasts (Stephen Pearce, Ryo Nakagawara, Darya Vanichkina, Emi Tanaka and Thomas Fung) who would be so eager to contribute to this project and learn about ggplot2 internals (very aptly put by Mitch while advertising the project. Smart move mate!)  Oh and what a fun and collaborative team to work with! See how they won’t stop coding:

[https://twitter.com/mitchoharawild/status/1205008586130149376] (Thanks to Steph who spent a lot of effort in making this gif)

<!-- While the project started with Mitch teasing me about gghdr whenever he would see me at Monash and then one fine day suddenly suggesting that we should work it out together at Ropensi. Little did we know that time there will be 8 enthusiasts who would be so eager to join and contribute to this project and learn about ggplot2 internals. It was indeed a very fun and collaborative team to work on (except that they refused to merge fluently). You can see some of the enthusiasm here: -->

Give the gif here

At the end of the two days, we could establish the following:

 1. `geom_hdr_boxplot()` to replace `hdr.boxplot()` to calculate HDR boxplots in one dimension.

<div class = "row">
<div class = "col-md-6">
```{r hdrcde-boxplot, echo=TRUE, message=FALSE, warning=FALSE}
library(hdrcde)
hdr.boxplot(faithful$eruptions) + title(main =  "HDR boxplots in hdrcde")
```
</div>
<div class = "col-md-6">
```{r gghdr-boxplot, echo=TRUE, message=FALSE, warning=FALSE}
library(gghdr)
library(ggplot2)
ggplot(faithful, aes(y = eruptions)) +
geom_hdr_boxplot() +
ggtitle("HDR boxplots in gghdr")
```
</div>
</div>

 2.  The interval bars in `hdr.den()` to be replaced with a rug plot to display HDRs of 1d marginal distributions in `geom_hdr_rug()`. `geom_density()` could then be added to the resultant plot to get plots equivant to `hdr.den()`.
 
 
<div class = "row">
<div class = "col-md-6">
```{r hdrcde-den, echo=TRUE, message=FALSE, warning=FALSE}
library(hdrcde)
hdr.den(faithful$eruptions,
        col = c("skyblue", "slateblue2", "slateblue4"))
```
</div>
<div class = "col-md-6">
```{r gghdr-den, echo=TRUE, message=FALSE, warning=FALSE}
library(gghdr)
library(ggplot2)
library(dplyr)
faithful %>% ggplot(aes(x = eruptions)) +
  geom_density(n= 1001) +
  geom_hdr_rug(fill=  "blue")
```
</div>
</div>

Also, display of 1d marginal distributions for both variables could be an useful feature to have.

```{r}
ggplot(faithful, aes(y = eruptions, x = waiting)) + 
    geom_hdr_rug(sides = "trbl", fill = "blue") + 
    geom_point()
```

3.  `hdr_bin()` to replace `hdrscatterplot()`. This would not be a geom rather a function to be added in the aesthetic color with each color representing a HDR with a specified coverage.

<div class = "row">
<div class = "col-md-6">
```{r hdrcde-scatterplot, echo=TRUE, message=FALSE, warning=FALSE}
hdrscatterplot(faithful$waiting,
               faithful$eruptions)
```
</div>
<div class = "col-md-6">
```{r gghdr-scatterplot, echo=TRUE, message=FALSE, warning=FALSE}
ggplot(data = faithful, 
       aes(x = waiting,
           y=eruptions)) +
  geom_point(aes(colour = hdr_bin(x = waiting,
                                  y = eruptions)))
```
</div>
</div>


 3. `geom_hdrcde_boxplot()`to replace `hdr.cde()` which is used to HDRS for a conditional density estimate.

<div class = "row">
<div class = "col-md-6">
```{r hdrcde-cde, echo=TRUE, message=FALSE, warning=FALSE}
faithful.cde <- cde(faithful$waiting,faithful$eruptions)
plot(faithful.cde,xlab="Waiting time",ylab="Duration time",plot.fn="hdr")
```
</div>
<div class = "col-md-6">
```{r gghdr-cde, echo=TRUE, message=FALSE, warning=FALSE}
ggplot(faithful, aes(x = eruptions, y = waiting)) + 
    geom_hdr_boxplot(fill="steelblue") + 
    theme_minimal()
```
</div>
</div>
- 
 4. We also deliberated on names of potential functions at the brainstorming stage which led to the idea of a [package design collaboration corner](https://github.com/ropensci/ozunconf19/issues/19).  Although rOpenSci strongly encourages to work even on projects that you might decide that very day, doing a bit of brainstorming on the project helped us to set the expectations right and communicate clearly to onboard the excellent team. 


# Bottlenecks along the way

- Now where there's a will, there's a way. Except that soon we could say where there is a merge, there is a conflict.  While most times we use Github as a code sharing, publishing software and collaborating with our future self, this was the time to show how we collaborate with others. It took almost 2 hours, Git kraken and Mitch to get us out of the merge conflicts.

(photo of the merge conflict tree)

- Extending ggplot2 (https://cran.r-project.org/web/packages/ggplot2/vignettes/extending-ggplot2.html) is not trivial when it comes to adding a geom. (writing about the scale problem that was faced).


<!-- Except that they refused to merge frequently - not in opinions but on Github. So much so that there was a point when we could say when there’s a merge there’s a conflict. -->
<!-- Look at the merge conflict graph at the end of two days which took around 1 hour to resolve. Git kraken and Mitch were immensely helpful in that :) Extending ggplot2 (https://cran.r-project.org/web/packages/ggplot2/vignettes/extending-ggplot2.html) is not trivial when it comes to adding a geom. -->

# Where to from here?

A missing piece is to replace the `hdr.boxplot.2d()` with `geom_hdr_boxplot.2d()`  which would calculate and plot HDRs in two dimensions. Nevertheless, we have the raw materials for an R package. All we need is some embellishment and review (lots) to get it to CRAN. Kudos team!

